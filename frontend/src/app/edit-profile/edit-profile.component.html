<!-- src/app/components/edit-profile/edit-profile.component.html -->

<div class="edit-profile-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>{{ existingProfile ? 'Edit Your Profile' : 'Create Your Profile' }}</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <form [formGroup]="profileForm" (ngSubmit)="onSubmit()">
        <!-- Biography -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Biography</mat-label>
          <textarea matInput formControlName="biography" rows="4" required></textarea>
          <mat-error *ngIf="profileForm.get('biography')?.hasError('required')">
            Biography is required
          </mat-error>
          <mat-error *ngIf="profileForm.get('biography')?.hasError('maxlength')">
            Biography cannot exceed 1024 characters
          </mat-error>
        </mat-form-field>

        <!-- Gender -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Gender</mat-label>
          <mat-select formControlName="gender" required>
            <mat-option *ngFor="let gender of genders" [value]="gender.gender_id">
              {{ gender.name }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="profileForm.get('gender')?.hasError('required')">
            Gender is required
          </mat-error>
        </mat-form-field>

        <!-- Sexual Preferences -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Sexual Preferences</mat-label>
          <mat-select formControlName="sexualPreferences" multiple required>
            <mat-option *ngFor="let preference of genders" [value]="preference.gender_id">
              {{ preference.name }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="profileForm.get('sexualPreferences')?.hasError('required')">
            Sexual preferences are required
          </mat-error>
        </mat-form-field>

        <!-- Age -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Age</mat-label>
          <input matInput type="number" formControlName="age" required>
          <mat-error *ngIf="profileForm.get('age')?.hasError('required')">
            Age is required
          </mat-error>
          <mat-error *ngIf="profileForm.get('age')?.hasError('min')">
            Minimum age is 18
          </mat-error>
          <mat-error *ngIf="profileForm.get('age')?.hasError('max')">
            Maximum age is 120
          </mat-error>
        </mat-form-field>

        <!-- Tags (Interests) -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Tags (Interests)</mat-label>
          <mat-select formControlName="tags" multiple>
            <mat-option *ngFor="let tag of tags" [value]="tag.tag_id">
              {{ tag.tag_name }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <!-- City -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>City</mat-label>
          <input matInput formControlName="city" required>
          <mat-error *ngIf="profileForm.get('city')?.hasError('required')">
            City is required
          </mat-error>
        </mat-form-field>

        <!-- Photo Upload Section -->
        <div class="photo-upload-section">
          <h3>Upload Photos</h3>
          <input type="file" (change)="onPhotoSelected($event)" multiple accept="image/*" />
          <div class="photo-preview">
            <div class="photo-item" *ngFor="let photo of photos">
              <img [src]="photo.url" [alt]="user?.username || 'User Photo'" />
              <button mat-icon-button color="warn" (click)="deletePhoto(photo)">
                <mat-icon>delete</mat-icon>
              </button>
              <button mat-icon-button color="primary" (click)="setAsMainPhoto(photo)" *ngIf="user?.main_photo_id !== photo.photo_id">
                <mat-icon>star</mat-icon>
              </button>
              <span *ngIf="user?.main_photo_id === photo.photo_id">Main Photo</span>
            </div>
          </div>
        </div>

        <!-- Submit Button -->
        <button
          mat-raised-button
          color="primary"
          type="submit"
          [disabled]="profileForm.invalid || isLoading"
          class="full-width"
        >
          <mat-progress-spinner
            *ngIf="isLoading"
            diameter="20"
            mode="indeterminate"
            color="accent"
          ></mat-progress-spinner>
          <span *ngIf="!isLoading">{{ existingProfile ? 'Update Profile' : 'Create Profile' }}</span>
        </button>
      </form>
    </mat-card-content>
  </mat-card>
</div>
